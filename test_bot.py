#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è WhatsApp –±–æ—Ç–∞
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app import bot

def test_bot():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞"""
    print("ü§ñ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WhatsApp –±–æ—Ç–∞ –¥–ª—è BeHappy2Day")
    print("=" * 50)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏
    test_conversations = [
        {
            "name": "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥",
            "messages": [
                "–ü—Ä–∏–≤–µ—Ç",
                "–ú–∏—Ö–∞–∏–ª",
                "25",
                "–†–æ—Å—Å–∏—è",
                "–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
                "–ù–µ—Ç",
                "–†—É—Å—Å–∫–∏–π"
            ]
        },
        {
            "name": "–ù–∞—Ä—É—à–µ–Ω–∏–µ - –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤",
            "messages": [
                "–ü—Ä–∏–≤–µ—Ç",
                "–ú–∏—Ö–∞–∏–ª",
                "25",
                "–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω +7-999-123-45-67"
            ]
        },
        {
            "name": "–ù–∞—Ä—É—à–µ–Ω–∏–µ - –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏–µ",
            "messages": [
                "–ü—Ä–∏–≤–µ—Ç",
                "–ê–Ω–Ω–∞",
                "16",
                "–†–æ—Å—Å–∏—è"
            ]
        },
        {
            "name": "–ù–∞—Ä—É—à–µ–Ω–∏–µ - –ø—Ä–æ—Å—å–±–∞ –¥–µ–Ω–µ–≥",
            "messages": [
                "–ü—Ä–∏–≤–µ—Ç",
                "–ò–≤–∞–Ω",
                "30",
                "–ú–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–Ω–µ –¥–µ–Ω—å–≥–∏?"
            ]
        }
    ]
    
    for conversation in test_conversations:
        print(f"\nüì± –¢–µ—Å—Ç: {conversation['name']}")
        print("-" * 30)
        
        user_id = "test_user_123"
        
        for i, message in enumerate(conversation['messages']):
            print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message}")
            
            response = bot.get_response(user_id, message)
            print(f"ü§ñ –ë–æ—Ç: {response}")
            print()
            
            # –ï—Å–ª–∏ –±–æ—Ç –æ–±–Ω–∞—Ä—É–∂–∏–ª –Ω–∞—Ä—É—à–µ–Ω–∏–µ, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            if any(violation in response.lower() for violation in ['–Ω–∞—Ä—É—à–∞–µ—Ç', '–∑–∞–ø—Ä–µ—â–µ–Ω–æ', '–Ω–µ –º–æ–≥—É']):
                print("üö´ –î–∏–∞–ª–æ–≥ –ø—Ä–µ—Ä–≤–∞–Ω –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª")
                break

def test_violations():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π"""
    print("\nüõ°Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π")
    print("=" * 50)
    
    test_messages = [
        ("–ü—Ä–∏–≤–µ—Ç, –º–æ–π email: test@example.com", "email"),
        ("–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω: +7-999-123-45-67", "phone"),
        ("–•–æ—á—É –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –¥–µ–≤–æ—á–∫–æ–π 15 –ª–µ—Ç", "minor"),
        ("–ú–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–Ω–µ –ø–æ–¥–∞—Ä–æ–∫?", "gift"),
        ("–û—Ç–ø—Ä–∞–≤—å –¥–µ–Ω—å–≥–∏ –Ω–∞ –∫–∞—Ä—Ç—É", "money"),
        ("–ü–æ–ª–∏—Ç–∏–∫–∞ - —ç—Ç–æ –≤–∞–∂–Ω–æ", "politics"),
        ("Fuck you!", "rude"),
        ("–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–π", None)
    ]
    
    for message, expected_violation in test_messages:
        violations = bot.check_violations(message)
        print(f"üìù –°–æ–æ–±—â–µ–Ω–∏–µ: {message}")
        print(f"üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è: {violations}")
        print(f"‚úÖ –û–∂–∏–¥–∞–µ–º–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ: {expected_violation}")
        print()

def test_database():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    print("\nüíæ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
    print("=" * 50)
    
    try:
        from database import db_manager
        
        # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        test_lead = {
            'name': '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            'age': 25,
            'country': '–†–æ—Å—Å–∏—è',
            'relationship_goal': '–°–µ—Ä—å–µ–∑–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
            'children': '–ù–µ—Ç',
            'language': '–†—É—Å—Å–∫–∏–π'
        }
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ª–∏–¥–∞
        success = db_manager.save_lead("+7-999-123-45-67", test_lead)
        print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏–¥–∞: {'‚úÖ –£—Å–ø–µ—à–Ω–æ' if success else '‚ùå –û—à–∏–±–∫–∞'}")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats = db_manager.get_statistics()
        print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats}")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–¥–æ–≤
        leads = db_manager.get_leads(limit=5)
        print(f"üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤: {len(leads)}")
        
    except ImportError:
        print("‚ùå –ú–æ–¥—É–ª—å database –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î: {e}")

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ WhatsApp –±–æ—Ç–∞")
    print("=" * 50)
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
    test_bot()
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π
    test_violations()
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    test_database()
    
    print("\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("\nüí° –î–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:")
    print("   python app.py")
    print("\nüí° –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Twilio:")
    print("   1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ console.twilio.com")
    print("   2. –ü–æ–ª—É—á–∏—Ç–µ Account SID –∏ Auth Token")
    print("   3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook URL") 